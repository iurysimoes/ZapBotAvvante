<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Validador de Volume</title>
  <script type="module">
    import { BrowserMultiFormatReader, NotFoundException } from 'https://cdn.jsdelivr.net/npm/@zxing/browser@0.0.10/+esm';

    const codeReader = new BrowserMultiFormatReader();
    const idPedido  = urlParams.get('idPedido');// substitua pelo ID real
    const userId = urlParams.get('userId'); // substitua pelo ID do usuário logado
    const finishButton = document.getElementById('finish-button');
    const loadingIndicator = document.getElementById('loading');
    const messageDiv = document.getElementById('message');

    function displayMessage(text, type = 'info') {
      messageDiv.innerText = text;
      messageDiv.className = type;
    }

    async function scanNext(selectedCamera) {
      try {
        const result = await codeReader.decodeOnceFromVideoDevice(selectedCamera.deviceId, 'video');
        
        loadingIndicator.style.display = 'block';
        displayMessage('Código detectado: ' + result.text, 'info');

        const response = await fetch('https://6761-177-30-111-194.ngrok-free.app/validar-volume', {
          method: 'POST',
          headers: { 'Content-Type': 'application/json' },
          body: JSON.stringify({
            idPedido,
            codigoBarras: result.text,
            userId
          })
        });

        const data = await response.json();

        displayMessage(data.mensagem, data.sucesso ? 'success' : 'error');

        if (data.sucesso && data.maisVolumes) {
          setTimeout(() => {
            scanNext(selectedCamera); // Lê o próximo código
          }, 1500);
        } else if (data.sucesso && !data.maisVolumes) {
          finishButton.style.display = 'block';
        } else {
          setTimeout(() => {
            scanNext(selectedCamera); // Tenta novamente em caso de erro
          }, 2000);
        }

      } catch (err) {
        if (err instanceof NotFoundException) {
          scanNext(selectedCamera); // Tenta de novo se não achar código
        } else {
          console.error('Erro ao ler código:', err);
          displayMessage('Erro ao ler código: ' + err.message, 'error');
          setTimeout(() => {
            scanNext(selectedCamera);
          }, 2000);
        }
      } finally {
        loadingIndicator.style.display = 'none';
      }
    }

    async function startScanner() {
      displayMessage('Aguardando código de barras...', 'info');
      loadingIndicator.style.display = 'none';
      finishButton.style.display = 'none';

      try {
        const videoInputDevices = await codeReader.getVideoInputDevices();
        const backCameras = videoInputDevices.filter(device =>
          device.label.toLowerCase().includes('back') ||
          device.label.toLowerCase().includes('trás')
        );

        const selectedCamera = backCameras.length > 0
          ? backCameras[backCameras.length - 1]
          : videoInputDevices[0];

        if (!selectedCamera) {
          displayMessage('Nenhuma câmera encontrada.', 'error');
          return;
        }

        scanNext(selectedCamera); // Começa a escanear

      } catch (error) {
        console.error('Erro ao iniciar a câmera:', error);
        displayMessage('Não foi possível iniciar a câmera.', 'error');
      }
    }

    window.onload = startScanner;
  </script>
  <style>
    body {
      font-family: sans-serif;
      padding: 20px;
      text-align: center;
      background: #f0f0f0;
    }
    video {
      width: 100%;
      max-width: 400px;
      border: 2px solid #ccc;
      border-radius: 8px;
    }
    #message {
      margin-top: 10px;
      padding: 10px;
      border-radius: 5px;
    }
    .success {
      background-color: #d4edda;
      color: #155724;
    }
    .error {
      background-color: #f8d7da;
      color: #721c24;
    }
    .info {
      background-color: #d1ecf1;
      color: #0c5460;
    }
    #loading {
      margin-top: 10px;
      font-weight: bold;
    }
    #finish-button {
      margin-top: 15px;
      padding: 10px 20px;
      background-color: #28a745;
      color: white;
      border: none;
      border-radius: 6px;
      font-size: 16px;
      display: none;
    }
  </style>
</head>
<body>
  <h2>Validador de Códigos de Barras</h2>
  <video id="video" autoplay muted></video>
  <div id="loading" style="display: none;">⏳ Validando volume...</div>
  <div id="message" class="info">Iniciando...</div>
  <button id="finish-button" onclick="alert('Processo finalizado!')">Finalizar</button>
</body>
</html>
