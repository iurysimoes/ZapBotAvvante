<script>
  const codeReader = new ZXing.BrowserBarcodeReader();
  const urlParams = new URLSearchParams(window.location.search);
  const idPedido = urlParams.get('idPedido');
  const userId = urlParams.get('userId');
  const mensagemElement = document.getElementById('mensagem');
  const loadingIndicator = document.getElementById('loading-indicator');
  const finishButton = document.getElementById('finish-button');

  let scanning = true;

  function displayMessage(message, type) {
    mensagemElement.innerText = message;
    mensagemElement.className = '';
    if (type) mensagemElement.classList.add(type);
  }

  async function startScanner() {
    scanning = true;
    displayMessage('Aguardando código de barras...', 'info');
    loadingIndicator.style.display = 'none';
    finishButton.style.display = 'none';

    try {
      const videoInputDevices = await codeReader.getVideoInputDevices();
      const backCameras = videoInputDevices.filter(device =>
        device.label.toLowerCase().includes('back') ||
        device.label.toLowerCase().includes('trás')
      );

      const selectedCamera = backCameras.length > 0
        ? backCameras[backCameras.length - 1]
        : videoInputDevices[0];

      if (!selectedCamera) {
        displayMessage('Nenhuma câmera encontrada.', 'error');
        return;
      }

      await codeReader.decodeFromVideoDevice(
        selectedCamera.deviceId,
        'video',
        async (result, err) => {
          if (!scanning) return;

          if (result) {
            scanning = false; // Pausa para não ler múltiplos de uma vez
            loadingIndicator.style.display = 'block';
            displayMessage('Código detectado: ' + result.text, 'info');

            try {
              const res = await fetch('https://cbc3-177-30-111-194.ngrok-free.app/validar-volume', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({
                  idPedido,
                  codigoBarras: result.text,
                  userId
                })
              });

              const data = await res.json();
              displayMessage(data.mensagem, data.sucesso ? 'success' : 'error');

              if (data.maisVolumes) {
                scanning = true; // Libera leitura para o próximo
              } else {
                codeReader.reset(); // Finaliza scanner
                scanning = false;
                finishButton.style.display = 'block';
              }
            } catch (fetchError) {
              displayMessage('Erro ao comunicar com o servidor.', 'error');
              scanning = true; // Permite nova leitura mesmo com erro
            } finally {
              loadingIndicator.style.display = 'none';
            }
          }

          if (err && !(err instanceof ZXing.NotFoundException)) {
            displayMessage('Erro na leitura: ' + err, 'error');
          }
        }
      );
    } catch (error) {
      displayMessage('Erro ao iniciar a câmera.', 'error');
    }
  }

  finishButton.addEventListener('click', () => {
    codeReader.reset();
    scanning = false;
    displayMessage('Escaneamento finalizado.', 'info');
    finishButton.style.display = 'none';
  });

  window.onload = startScanner;
</script>
